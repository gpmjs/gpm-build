#!/usr/bin/env node

var chalk = require('chalk');
var path = require('path');
var exec = require('child_process').exec;
var program = require('commander');
var spawn = require('win-spawn');
var Promise = require("bluebird");
var fs = Promise.promisifyAll(require('fs-extra'));

var INIT_CWD = process.cwd();
var FILE_NAME = 'gpmfile.js';

process.env.GPM_INIT_CWD = INIT_CWD;

(function copyFile(){
   var targetFile = path.normalize(__dirname + 'bin//../lib/' + FILE_NAME);

   fs.removeAsync(targetFile).then(function(err){
      if (err) {
        return console.error(err)
      }
   });

   fs.copyAsync(path.normalize(INIT_CWD + '/' + FILE_NAME), targetFile)
    .then(function(err){
        if (err) {
          return console.error(err)
        }
        fn();
    });
})();

function fn(){
  var gulpcmd = require('../lib/util/gulpcmd.js');

  program
    .version(require('../package').version, '-v, --version')
      .usage('<command> [options]')
      .on('--help', gulpcmd.printHelp)
      .parse(process.argv);

  var letter = 'cd ' + path.normalize(__dirname + 'bin//../');
  var task = program.args[0];;
  var cmd = 'gulp ' + task;

  process.env.GPM_TASK = task;

  gulpcmd.execCmd(task, wrap, function(){
      program.help();
  });

  function wrap() {
      var execCmd = letter + '&&' + cmd;

      exec(execCmd, function(error, stdout, stderr){
        if (error) {
          console.log(stdout);
          console.log(error);
          process.exit();
        }
        console.log(stdout);
        process.exit();
      });
  }
}
